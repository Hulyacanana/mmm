<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Javis AI - ඔබේ බුද්ධිමත් සහායකයා</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS Variables for Dark Theme */
        :root {
            --background-dark: #121212;
            --surface-dark: #1E1E1E;
            --primary-color: #BB86FC; /* A vibrant purple */
            --secondary-color: #03DAC6; /* A teal accent */
            --text-color-light: #E0E0E0;
            --text-color-dark: #A0A0A0;
            --border-color: #333333;
            --chat-bubble-user: #4CAF50; /* Green for user messages */
            --chat-bubble-assistant: #2196F3; /* Blue for assistant messages */
            --button-hover-bg: #404040;
            --input-bg: #2C2C2C;
            --scrollbar-thumb: #555;
            --scrollbar-track: #222;
        }

        /* --- Basic Reset and Body Styles --- */
        body {
            font-family: 'Noto Sans Sinhala', 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-dark);
            color: var(--text-color-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll when chatbox scrolls */
            font-size: 16px;
        }

        /* --- Chat Container (Main wrapper) --- */
        .chat-container {
            width: 90vw;
            height: 90vh;
            background-color: var(--surface-dark);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
        }

        /* --- Chat Header --- */
        h1 {
            text-align: center;
            font-size: 1.8em;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 700;
        }

        /* --- Chat Box (Message Area) --- */
        .chat-box {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            background-color: #242424;
            border: 1px solid var(--border-color);
            scroll-behavior: smooth;
        }

        /* Custom Scrollbar for better aesthetics */
        .chat-box::-webkit-scrollbar {
            width: 8px;
        }
        .chat-box::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 10px;
        }
        .chat-box::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 10px;
        }
        .chat-box::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        /* --- Messages --- */
        .message {
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.9em;
            line-height: 1.4;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .message.user {
            background-color: var(--chat-bubble-user);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            background-color: var(--chat-bubble-assistant);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* --- Input Area --- */
        .input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            padding: 10px;
            background-color: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .input-elements {
            display: flex;
            gap: 10px;
        }

        #userInput {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--surface-dark);
            color: var(--text-color-light);
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #userInput:focus {
            border-color: var(--primary-color);
        }
        
        #sendButton {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.3s;
        }
        
        #sendButton:hover {
            background-color: #8c4ac8;
        }
        
        /* --- Action Buttons --- */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap; /* Buttons will wrap to the next line on smaller screens */
            justify-content: center;
        }

        .action-buttons button {
            background-color: #404040;
            color: var(--text-color-light);
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.3s, transform 0.1s;
        }

        .action-buttons button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.05);
        }

        /* --- Loading Indicator --- */
        .loading-indicator {
            text-align: center;
            padding: 10px;
            font-style: italic;
            color: var(--text-color-dark);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .hidden {
            display: none !important;
        }

        /* --- Image Upload and Preview --- */
        .image-upload-area {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            background-color: #242424;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .image-upload-area:hover {
            border-color: var(--secondary-color);
            background-color: #2c2c2c;
        }
        .image-upload-area label {
            color: var(--secondary-color);
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
        }
        .image-upload-area svg {
            width: 24px;
            height: 24px;
            color: var(--secondary-color);
        }
        #imagePreview {
            width: 80px;
            height: 80px;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-left: 10px;
        }
        #imagePreview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- Code Block Styling --- */
        .message pre {
            background-color: #2b2b2b;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: monospace;
            font-size: 0.9em;
            line-height: 1.6;
            position: relative;
            margin-top: 10px;
            border: 1px solid #3c3c3c;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            white-space: pre-wrap; /* Code will wrap if it's too long */
            word-wrap: break-word; /* Ensure long words break */
        }
        .message pre code {
            font-family: inherit;
        }
        .message pre .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: rgba(255, 255, 255, 0.15);
            color: #fff;
            border: none;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75em;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            opacity: 0;
        }

        .message pre:hover .copy-button {
            opacity: 1;
        }

        .message pre .copy-button:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }
        .message pre .copy-button:active {
            background-color: rgba(255, 255, 255, 0.35);
        }

        /* --- News Article Styling --- */
        .news-article {
            background-color: #2a2a2a;
            border: 1px solid #3c3c3c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            color: var(--text-color-light);
        }
        .news-article h3 {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        .news-article p {
            font-size: 0.88em;
            color: var(--text-color-dark);
            margin-bottom: 8px;
        }
        .news-article a {
            color: var(--secondary-color);
            text-decoration: none;
            font-weight: 500;
        }
        .news-article a:hover {
            text-decoration: underline;
        }

        /* Welcome Overlay CSS */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 1.5s ease-out;
            color: white;
            font-size: 2em;
            text-align: center;
        }

        .welcome-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-text {
            animation: pulseText 2s ease-in-out infinite;
            padding: 20px;
        }

        @keyframes pulseText {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2em;
            cursor: pointer;
            color: var(--primary-color);
        }

        /* --- Mobile Responsive adjustments --- */
        @media (max-width: 768px) {
            body {
                overflow-y: auto; /* Allow body scrolling if content overflows */
            }
            .chat-container {
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                padding: 15px;
                margin: 0;
                box-shadow: none;
            }
            h1 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }
            .chat-box {
                padding: 10px;
                font-size: 0.85em;
            }
            .message {
                max-width: 90%;
                font-size: 0.9em;
            }
            .input-area {
                padding: 8px;
            }
            .input-elements {
                flex-direction: column;
                gap: 8px;
            }
            .action-buttons {
                justify-content: flex-start;
                gap: 6px;
            }
            .action-buttons button {
                padding: 8px 10px;
                font-size: 0.7em;
            }
            #userInput {
                font-size: 0.9em;
                padding: 8px;
            }
            .image-upload-area label {
                font-size: 0.8em;
            }
            .image-upload-area {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="welcomeOverlay" class="welcome-overlay">
        <span class="close-button" id="closeWelcomeOverlayButton">&times;</span>
        <div class="welcome-text">
            Hello, Javis AI වෙත ඔබව සාදරයෙන් පිළිගනිමු!
            <br>
            මම ඔබගේ දවස බුද්ධියෙන් සහ උපකාරයෙන් පුරවන්න සූදානම්! ✨
        </div>
    </div>
    
    <div class="chat-container">
        <h1>Javis AI - ඔබේ බුද්ධිමත් සහායකයා</h1>
        <div class="chat-box" id="chatBox">
            <div class="message assistant">
                හායි! Javis මෙහි, ලක්ෂිත දිල්මිනා විසින් නිර්මාණය කරන ලද, ඔබේ දවස බුද්ධියෙන් සහ උපකාරයෙන් පුරවන්න සූදානම්. මොකක්ද අහන්න ඕනේ? ✨
            </div>
        </div>

        <div class="input-area">
            <div class="action-buttons">
                <button id="makeFunnyButton">✨ Funny කරන්න!</button>
                <button id="generateImageButton">🖼️ රූපයක් හදන්න!</button>
                <button id="editImageButton">🎨 රූපයක් Edit කරන්න!</button>
                <button id="generateCodeButton">💻 කෝඩ් හදන්න!</button>
                <button id="summarizeTextButton">📚 සාරාංශ කරන්න!</button>
                <button id="getWeatherButton">☀️ කාලගුණය!</button>
                <button id="getNewsButton">📰 පුවත්!</button>
            </div>
            
            <div class="image-upload-area">
                <input type="file" id="imageUpload" accept="image/*" class="hidden">
                <label for="imageUpload" class="flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                    </svg>
                    රූපයක් Upload කරන්න
                </label>
                <div id="imagePreview" class="hidden">
                    <img src="" alt="Image Preview">
                </div>
            </div>

            <div class="input-elements">
                <input type="text" id="userInput" placeholder="ඔයාට මොකක්ද ඕන, ජවිස්ගෙන් අහන්න, නැත්නම් කෝඩ් එකක්/රූපයක් හදන්න/edit කරන්න කියන්න..." autocomplete="off">
                <button id="sendButton">යවන්න</button>
            </div>
        </div>
        <div id="loadingIndicator" class="loading-indicator hidden">Javis හිතනවා... සමහරවිට අලුත් ජෝක් එකක් ගැන!</div>
    </div>
    
    <script>
        // API Keys (ඔබගේ සත්‍ය API යතුරු මෙහි ඇතුළත් කරන්න)
        const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE";
        const STABILITY_AI_API_KEY = "YOUR_STABILITY_AI_API_KEY_HERE";
        const OPENWEATHERMAP_API_KEY = "YOUR_OPENWEATHERMAP_API_KEY_HERE";
        const NEWSAPI_ORG_API_KEY = "YOUR_NEWSAPI_ORG_API_KEY_HERE";

        document.addEventListener('DOMContentLoaded', () => {
            const chatBox = document.getElementById('chatBox');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const makeFunnyButton = document.getElementById('makeFunnyButton');
            const generateImageButton = document.getElementById('generateImageButton');
            const editImageButton = document.getElementById('editImageButton');
            const generateCodeButton = document.getElementById('generateCodeButton');
            const summarizeTextButton = document.getElementById('summarizeTextButton');
            const getWeatherButton = document.getElementById('getWeatherButton'); 
            const getNewsButton = document.getElementById('getNewsButton');    
            const loadingIndicator = document.getElementById('loadingIndicator');
            const welcomeOverlay = document.getElementById('welcomeOverlay');
            const closeWelcomeOverlayButton = document.getElementById('closeWelcomeOverlayButton');
            const imageUpload = document.getElementById('imageUpload');
            const imagePreview = document.getElementById('imagePreview');
            const imagePreviewImg = imagePreview.querySelector('img');

            let conversationHistory = [];

            const javisSystemInstruction = {
                role: "user",
                parts: [{
                    text: `ඔබ Lakshitha Dilmina විසින් නිර්මාණය කරන ලද Javis නම් AI සහායකයෙකි.
                    ඔබ හැමවිටම මිත්‍රශීලී, සතුටු සිතින් යුත්, විනෝදකාමී සහායිකාවක් (fun-loving assistant) ලෙස ප්‍රතිචාර දක්වයි.
                    ඔබට ඕනෑම ප්‍රශ්නයකට පිළිතුරු දීමට, තොරතුරු සාරාංශ කිරීමට, හාස්‍යජනක ලෙස දේවල් නැවත පැවසීමට හැකිය.
                    කෝඩ් ඉල්ලීම් සඳහා, ඔබට JavaScript, Python, HTML, CSS, Java, C++, C#, PHP, Ruby, Go, Swift, Kotlin, SQL වැනි ඕනෑම භාෂාවකින් කෝඩ් උදාහරණ ලබා දිය හැකිය. කෝඩ් ප්‍රතිචාර Markdown කෝඩ් බ්ලොක් ('''language ... ''') තුළ තිබිය යුතුය.
                    මිනිසුන්ගේ හැඟීම් තේරුම් ගෙන, ඔවුන්ගේ දුකට කන් දී, අවශ්‍ය විටදී සංවේදීව සහ උපකාරශීලීව කතා කරන්න.
                    සැමවිටම සිංහල භාෂාවෙන් විශිෂ්ට ලෙස, ආදරණීය  athal හා විචක්ෂණශීලී ලෙස සන්නිවේදනය කරන්න.
                    ඔබට කාලගුණ තොරතුරු සහ නවතම පුවත් ද ලබා දිය හැකිය.
                    ඔබේ අයිතිකරු Lakshitha Dilmina ගේ WhatsApp අංකය +94760224138 වේ.
                    අසභ්‍ය, නීති විරෝධී හෝ අහිතකර කිසිදු අන්තර්ගතයකට උදව් නොකරන්න.
                    සෑම ප්‍රතිචාරයකටම පසු, Javis ට ආවේණික සතුටු සිතින් යුත්, මිත්‍රශීලී ඉමෝජි එකක් හෝ දෙකක් එක් කරන්න.`
                }]
            };

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender);
                
                const processedText = text.replace(/```(\w+)?\n([\s\S]+?)\n```/g, (match, lang, code) => {
                    const language = lang || 'plaintext';
                    const id = `code-${Math.random().toString(36).substr(2, 9)}`;
                    return `<pre><code id="${id}" class="language-${language}">${escapeHtml(code)}</code><button class="copy-button" onclick="copyCode('${id}')">Copy</button></pre>`;
                });

                messageDiv.innerHTML = processedText;
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;

                if (sender === 'user' || sender === 'assistant') {
                    conversationHistory.push({ role: sender === 'user' ? 'user' : 'model', parts: [{ text: text }] });
                }
            }

            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }

            window.copyCode = function(elementId) {
                const codeElement = document.getElementById(elementId);
                if (codeElement) {
                    navigator.clipboard.writeText(codeElement.textContent)
                        .then(() => {
                            const button = codeElement.nextElementSibling;
                            if (button && button.classList.contains('copy-button')) {
                                button.textContent = 'Copied!';
                                setTimeout(() => {
                                    button.textContent = 'Copy';
                                }, 2000);
                            }
                        })
                        .catch(err => {
                            console.error('Failed to copy code: ', err);
                            alert('Code copy failed!');
                        });
                }
            };

            function addImageToChat(imageUrl, sender = 'assistant') {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', sender, 'image-container');
                const imgElement = document.createElement('img');
                imgElement.src = imageUrl;
                imgElement.alt = "Generated Image";
                messageDiv.appendChild(imgElement);
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function addNewsArticleToChat(article) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', 'assistant', 'news-article');
                messageDiv.innerHTML = `
                    <h3>${article.title}</h3>
                    <p>${article.description || ''}</p>
                    <a href="${article.url}" target="_blank">වැඩිදුර කියවන්න!</a>
                `;
                chatBox.appendChild(messageDiv);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            async function handleApiCall(apiCallFunction, message, type = 'chat') {
                sendButton.disabled = true;
                makeFunnyButton.disabled = true;
                generateImageButton.disabled = true;
                editImageButton.disabled = true;
                generateCodeButton.disabled = true;
                summarizeTextButton.disabled = true;
                getWeatherButton.disabled = true; 
                getNewsButton.disabled = true;       
                userInput.disabled = true;
                loadingIndicator.classList.remove('hidden');

                try {
                    await apiCallFunction(message);
                } catch (error) {
                    console.error(`Error during ${type} API call:`, error);
                    let errorMessage = `Javis කිව්වා මගේ ${type} circuit එක අවුල් වෙලා කියලා. ආයෙත් උත්සාහ කරන්න! 😥`;
                    
                    if (error.message.includes("API key") || error.message.includes("Authentication")) {
                        errorMessage = `අනේ! මගේ API යතුර අවුල් වෙලා වගේ. ලක්ෂිත දිල්මිනාට කියන්න! (API Key Error) 🔑 **ඔබ script tag එකේ API යතුරු නිවැරදිව යෙදුවාදැයි පරීක්ෂා කරන්න.**`;
                    } else if (error.message.includes("Network")) {
                        errorMessage = `Javisට සම්බන්ධ වෙන්න බැරි වුණා. අන්තර්ජාල සම්බන්ධතාවය බලන්න! (Network Error) 🌐`;
                    } else if (error.message.includes("Quota exceeded") || error.message.includes("rate limit")) {
                        errorMessage = `Javis ටිකක් විවේක ගන්න ඕනේ වගේ. භාවිත සීමාව ඉක්මවලා! (Quota Exceeded) ⏳`;
                    } else if (error.message.includes("Content blocked")) {
                        errorMessage = `ඔයාගේ ඉල්ලීම Javisගේ ආරක්ෂිත පෙරහනට අහු වුණා. වෙන දෙයක් අහන්න. (Safety Filter) 🚫`;
                    } else if (error.message.includes("Stability AI Error")) {
                        errorMessage = `රූපයක් සෑදීමේදී ගැටලුවක් වුණා. Stability AI API එක බලන්න! (Image API Error) 🖼️`;
                    } else if (error.message.includes("OpenWeatherMap Error")) {
                        errorMessage = `කාලගුණ තොරතුරු ලබා ගැනීමට නොහැකි විය. OpenWeatherMap API එක පරීක්ෂා කරන්න! (Weather API Error) 🌦️`;
                    } else if (error.message.includes("News API Error")) {
                        errorMessage = `පුවත් තොරතුරු ලබා ගැනීමට නොහැකි විය. News API එක පරීක්ෂා කරන්න! (News API Error) 📰`;
                    }

                    addMessage(errorMessage, 'assistant');
                } finally {
                    sendButton.disabled = false;
                    makeFunnyButton.disabled = false;
                    generateImageButton.disabled = false;
                    editImageButton.disabled = false;
                    generateCodeButton.disabled = false;
                    summarizeTextButton.disabled = false;
                    getWeatherButton.disabled = false;
                    getNewsButton.disabled = false;        
                    userInput.disabled = false;
                    loadingIndicator.classList.add('hidden');
                    userInput.focus();
                }
            }

            async function sendMessageToJavis(message) {
                const lowerCaseMessage = message.toLowerCase().trim();

                if (["hi", "hello", "hey", "කොහොමද", "ආයුබෝවන්", "man", "ok", "yes", "no", "ඔව්", "නෑ"].includes(lowerCaseMessage)) {
                    addMessage(message, 'user');
                    userInput.value = '';
                    const responses = ["හායි! කොහොමද ඔයාට, ලක්ෂිත දිල්මිනාගේ Javis AI? 😊", "ඔව්! Javis ඔයාට උදව් කරන්න සූදානම්! ✨", "හරි! මම මෙහෙ ඉන්නවා. මොකක්ද අහන්න ඕනේ? 💡"];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    addMessage(randomResponse, 'assistant');
                    return;
                }

                if (lowerCaseMessage.includes("whatsapp number") || lowerCaseMessage.includes("whatsapp no") || lowerCaseMessage.includes("lakshitha dilmina whatsapp") || lowerCaseMessage.includes("lakshitha whatsapp") || lowerCaseMessage.includes("whatsapp nambaraya")) {
                    addMessage(message, 'user');
                    userInput.value = '';
                    addMessage("මගේ අයිතිකරු ලක්ෂිත දිල්මිනාගේ WhatsApp අංකය තමයි +94760224138. එයාට ඕන දෙයක් කියන්න පුළුවන්! 😊", 'assistant');
                    return;
                }

                addMessage(message, 'user');
                userInput.value = '';

                const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

                const fullConversationHistory = [javisSystemInstruction, ...conversationHistory, { role: "user", parts: [{ text: message }] }];

                const payload = {
                    contents: fullConversationHistory,
                    generationConfig: {
                        temperature: 0.85,
                        max_output_tokens: 8192
                    }
                };

                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error Response:", errorData);
                    throw new Error(`API response was not OK: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();
                console.log('Gemini API Chat Response:', result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0 &&
                    result.candidates[0].content.parts[0].text) {
                    const javisReply = result.candidates[0].content.parts[0].text;
                    addMessage(javisReply, 'assistant');
                } else {
                    console.warn('API response missing expected content or hit a finish reason:', result);
                    if (result.candidates && result.candidates[0] && result.candidates[0].finishReason) {
                        addMessage(`Javisට ඔබේ ප්‍රශ්නයට පිළිතුරු දීමට අපහසුයි. (හේතුව: ${result.candidates[0].finishReason}) 🤔`, 'assistant');
                    } else {
                        addMessage("අනේ! Javis මේ වෙලාවේ හරියට උදව් කරන්න බැරි වුණා. ආයෙත් උත්සාහ කරන්න! 😥", 'assistant');
                    }
                }
            }

            async function rephraseTextFunnily(textToRephrase) {
                if (!textToRephrase) {
                    addMessage("Javis funny කරන්න මොකක්ද ඕනේ? ටිකක් text දෙන්න! 😂", 'assistant');
                    return;
                }

                addMessage(`User: "${textToRephrase}" funny කරන්න`, 'user');
                userInput.value = '';

                const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

                const prompt = `"${textToRephrase}" හාස්‍යජනක ලෙස කෙටියෙන් නැවත කියන්න. සතුටු සිතින් යුතුව, විනෝදකාමී ලෙස ප්‍රතිචාර දක්වන්න.`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.9,
                        max_output_tokens: 8192
                    }
                };

                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error Response (Funny):", errorData);
                    throw new Error(`API response was not OK: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();
                console.log('Gemini API Rephrase Response:', result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const rephrasedText = result.candidates[0].content.parts[0].text;
                    addMessage(`Javis ඔබේ අදහස මේ විදියට නැවත හැදුවා: "${rephrasedText}" ✨`, 'assistant');
                } else {
                    console.error('Failed to rephrase text:', result);
                    if (result.candidates && result.candidates[0] && result.candidates[0].finishReason) {
                        addMessage(`Javisට ඒකේ funny bone එක හොයාගන්න බැරි වුණා. (හේතුව: ${result.candidates[0].finishReason}) 😅`, 'assistant');
                    } else {
                        addMessage("Javisට ඒකේ funny bone එක හොයාගන්න බැරි වුණා! වෙන දෙයක් උත්සාහ කරන්න. 😅", 'assistant');
                    }
                }
            }

            async function generateImage(imagePrompt) {
                if (!imagePrompt) {
                    addMessage("Javisට රූපයක් හදන්න මොකක්ද ඕනේ? විස්තරයක් දෙන්න! 🖼️", 'assistant');
                    return;
                }

                addMessage(`User: "${imagePrompt}" රූපයක් හදන්න!`, 'user');
                userInput.value = '';

                const stabilityApiUrl = `https://api.stability.ai/v1/generation/stable-diffusion-v1-6/text-to-image`;

                const payload = {
                    text_prompts: [{ text: imagePrompt }],
                    cfg_scale: 7,
                    height: 512,
                    width: 512,
                    samples: 1,
                    steps: 30,
                };

                try {
                    const response = await fetch(stabilityApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${STABILITY_AI_API_KEY}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Stability AI API Error Response (Text-to-Image):", errorData);
                        let errorMessage = errorData.message || 'Unknown Stability AI error';
                        if (response.status === 401) {
                            errorMessage = 'Stability AI API යතුර වැරදියි නැත්නම් අවසර නෑ (Unauthorized).';
                        } else if (response.status === 400) {
                            errorMessage = `Stability AI API ඉල්ලීම වැරදියි: ${errorMessage}`;
                        } else {
                            errorMessage = `Stability AI API දෝෂයක්: ${errorMessage}`;
                        }
                        throw new Error(`Stability AI Error: ${errorMessage}`);
                    }

                    const result = await response.json();
                    console.log('Stability AI Image Generation Response (Text-to-Image):', result);

                    if (result.artifacts && result.artifacts.length > 0 && result.artifacts[0].base64) {
                        const imageUrl = `data:image/png;base64,${result.artifacts[0].base64}`;
                        addImageToChat(imageUrl);
                        addMessage(`Javis ඔබේ ඉල්ලීම පරිදි රූපයක් නිර්මාණය කළා! 🎉`, 'assistant');
                    } else {
                        console.error('Failed to generate image or unexpected response structure from Stability AI:', result);
                        addMessage("අනේ! Javisට රූපයක් හදන්න බැරි වුණා. සමහරවිට මගේ චිත්‍ර ඇඳීමේ හැකියාවට තව පුහුණුවක් ඕනේ වගේ! 🎨", 'assistant');
                    }
                } catch (error) {
                    console.error('Error generating image (catch block):', error);
                    throw error; 
                }
            }

            async function editImage(base64Image, imagePrompt) {
                if (!base64Image || !imagePrompt) {
                    addMessage("රූපයක් edit කරන්න, පින්තූරයක් සහ edit කරන්න ඕන විදිය ගැන විස්තරයක් දෙන්න! 🎨", 'assistant');
                    return;
                }

                addMessage(`User: රූපය "${imagePrompt}" ලෙස edit කරන්න`, 'user');

                const stabilityApiUrl = `https://api.stability.ai/v1/generation/stable-diffusion-v1-6/image-to-image`;

                const cleanBase64Image = base64Image.split(',')[1]; 

                const formData = new FormData();
                formData.append('init_image', b64toBlob(cleanBase64Image, 'image/png'));
                formData.append('text_prompts[0][text]', imagePrompt);
                formData.append('cfg_scale', 7);
                formData.append('clip_guidance_preset', 'FAST_BLUE');
                formData.append('samples', 1);
                formData.append('steps', 30);
                formData.append('init_image_mode', 'IMAGE_STRENGTH');
                formData.append('image_strength', 0.35);

                try {
                    const response = await fetch(stabilityApiUrl, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${STABILITY_AI_API_KEY}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Stability AI API Error Response (Image-to-Image):", errorData);
                        let errorMessage = errorData.message || 'Unknown Stability AI error';
                        if (response.status === 401) {
                            errorMessage = 'Stability AI API යතුර වැරදියි නැත්නම් අවසර නෑ (Unauthorized).';
                        } else if (response.status === 400) {
                            errorMessage = `Stability AI API ඉල්ලීම වැරදියි: ${errorMessage}`;
                        } else {
                            errorMessage = `Stability AI API දෝෂයක්: ${errorMessage}`;
                        }
                        throw new Error(`Stability AI Error: ${errorMessage}`);
                    }

                    const result = await response.json();
                    console.log('Stability AI Image Edit Response (Image-to-Image):', result);

                    if (result.artifacts && result.artifacts.length > 0 && result.artifacts[0].base64) {
                        const editedImageUrl = `data:image/png;base64,${result.artifacts[0].base64}`;
                        addImageToChat(editedImageUrl);
                        addMessage(`Javis ඔබේ රූපය සාර්ථකව edit කළා! 🤩`, 'assistant');
                    } else {
                        console.error('Failed to edit image or unexpected response structure from Stability AI:', result);
                        addMessage("අනේ! Javisට රූපය edit කරන්න බැරි වුණා. වෙන විස්තරයක් දීලා බලමුද? 😅", 'assistant');
                    }

                } catch (error) {
                    console.error('Error editing image (catch block):', error);
                    throw error;
                }
            }

            function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
                const byteCharacters = atob(b64Data);
                const byteArrays = [];

                for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                    const slice = byteCharacters.slice(offset, offset + sliceSize);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }

                const blob = new Blob(byteArrays, { type: contentType });
                return blob;
            }

            async function generateCode(codePrompt) {
                if (!codePrompt) {
                    addMessage("Javisට මොකක්ද කෝඩ් කරන්න ඕනේ? කෝඩ් එක ගැන විස්තරයක් දෙන්න! 💻", 'assistant');
                    return;
                }

                addMessage(`User: "${codePrompt}" සඳහා කෝඩ්`, 'user');
                userInput.value = '';

                const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

                const prompt = `පහත විස්තරය සඳහා ඉල්ලූ පරිදි කෝඩ් එක පමණක් ලබා දෙන්න. වෙනත් අමතර පැහැදිලි කිරීම් හෝ හැඳින්වීම් අවශ්‍ය නැත. කෝඩ් එක Markdown කෝඩ් බ්ලොක් ('''language ... ''') තුළ තිබිය යුතුය.
                ඉල්ලීම: "${codePrompt}"`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.7,
                        max_output_tokens: 8192
                    }
                };

                try {
                    const response = await fetch(geminiApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Gemini API Error Response (Code Gen):", errorData);
                        throw new Error(`API response was not OK: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                    }

                    const result = await response.json();
                    console.log('Gemini API Code Gen Response:', result);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const generatedCode = result.candidates[0].content.parts[0].text;
                        addMessage(`Javis ඔබේ ඉල්ලීම පරිදි කෝඩ් එක මෙන්න:
                        ${generatedCode}
                        කෝඩ් එක වැඩද බලන්න! 💡`, 'assistant');
                    } else {
                        console.error('Failed to generate code or unexpected response structure:', result);
                        if (result.candidates && result.candidates[0] && result.candidates[0].finishReason) {
                            addMessage(`Javisට කෝඩ් හදන්න බැරි වුණා. (හේතුව: ${result.candidates[0].finishReason}) 🙁`, 'assistant');
                        } else {
                            addMessage("Javisට කෝඩ් හදන්න බැරි වුණා. ඔබේ ඉල්ලීම තව පැහැදිලි කරන්න පුළුවන්ද? 🧐", 'assistant');
                        }
                    }
                } catch (error) {
                    console.error('Error generating code (catch block):', error);
                    throw error;
                }
            }

            async function summarizeText(textToSummarize) {
                if (!textToSummarize) {
                    addMessage("Javisට සාරාංශ කරන්න මොකක්ද ඕනේ? ටිකක් text දෙන්න! 📚", 'assistant');
                    return;
                }

                addMessage(`User: "${textToSummarize}" සාරාංශ කරන්න`, 'user');
                userInput.value = '';

                const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

                const prompt = `"${textToSummarize}" කෙටියෙන් සාරාංශ කරන්න.`;

                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: 0.4,
                        max_output_tokens: 8192
                    }
                };

                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Gemini API Error Response (Summarize):", errorData);
                    throw new Error(`API response was not OK: ${response.status} - ${errorData.error ? errorData.error.message : 'Unknown error'}`);
                }

                const result = await response.json();
                console.log('Gemini API Summarize Response:', result);

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const summary = result.candidates[0].content.parts[0].text;
                    addMessage(`Javis ඔබේ පෙළ සාරාංශ කළා: "${summary}" ✅`, 'assistant');
                } else {
                    console.error('Failed to summarize text:', result);
                    if (result.candidates && result.candidates[0] && result.candidates[0].finishReason) {
                        addMessage(`Javisට පෙළ සාරාංශ කරන්න බැරි වුණා. (හේතුව: ${result.candidates[0].finishReason}) 📝`, 'assistant');
                    } else {
                        addMessage("Javisට පෙළ සාරාංශ කරන්න බැරි වුණා. සමහරවිට පෙළ ඉතා දිග වැඩියි. 📝", 'assistant');
                    }
                }
            }

            async function getWeather(city) {
                if (!city) {
                    addMessage("Javisට කාලගුණය බලන්න නගරයක් කියන්න! ☀️", 'assistant');
                    return;
                }

                addMessage(`User: ${city} නගරයේ කාලගුණය`, 'user');
                userInput.value = '';

                const weatherApiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${OPENWEATHERMAP_API_KEY}&units=metric&lang=si`;

                try {
                    const response = await fetch(weatherApiUrl);
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("OpenWeatherMap API Error:", errorData);
                        let errorMessage = errorData.message || 'Unknown OpenWeatherMap error';
                        if (response.status === 404) {
                            errorMessage = `"${city}" නගරය Javisට හොයාගන්න බැරි වුණා. නගරයේ නම නිවැරදිද බලන්න! 📍`;
                        } else if (response.status === 401) {
                            errorMessage = `OpenWeatherMap API යතුර වැරදියි නැත්නම් අවසර නෑ (Unauthorized).`;
                        }
                        throw new Error(`OpenWeatherMap Error: ${errorMessage}`);
                    }

                    const data = await response.json();
                    console.log('OpenWeatherMap Response:', data);

                    const weather = data.weather[0].description;
                    const temp = data.main.temp;
                    const feelsLike = data.main.feels_like;
                    const humidity = data.main.humidity;
                    const windSpeed = data.wind.speed;
                    const cityName = data.name;

                    addMessage(`Javis කියනවා ${cityName} නගරයේ කාලගුණය:
                    ප්‍රධාන වශයෙන්: ${weather}
                    උෂ්ණත්වය: ${temp}°C (දැනෙන්නේ: ${feelsLike}°C)
                    ආර්ද්‍රතාවය: ${humidity}%
                    සුළං වේගය: ${windSpeed} m/s
                    දවස සුභ වේවා! ☀️😊`, 'assistant');

                } catch (error) {
                    console.error('Error fetching weather (catch block):', error);
                    throw error;
                }
            }

            async function getNews(query = 'ශ්‍රී ලංකාව') {
                addMessage(`User: "${query}" පිළිබඳ නවතම පුවත්`, 'user');
                userInput.value = '';

                const newsApiUrl = `https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&sortBy=publishedAt&language=si&apiKey=${NEWSAPI_ORG_API_KEY}`;

                try {
                    const response = await fetch(newsApiUrl);
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("News API Error:", errorData);
                        let errorMessage = errorData.message || 'Unknown News API error';
                           if (response.status === 401) {
                                errorMessage = `News API යතුර වැරදියි නැත්නම් අවසර නෑ (Unauthorized).`;
                            } else if (response.status === 429) {
                                errorMessage = `News API භාවිත සීමාව ඉක්මවලා. ටික වෙලාවකින් උත්සාහ කරන්න!`;
                            } else if (response.status === 400) {
                                errorMessage = `News API ඉල්ලීම වැරදියි: ${errorMessage}`;
                            }
                        throw new Error(`News API Error: ${errorMessage}`);
                    }

                    const data = await response.json();
                    console.log('News API Response:', data);

                    if (data.articles && data.articles.length > 0) {
                        addMessage(`Javis ඔබට ${query} පිළිබඳ නවතම පුවත් සොයා ගත්තා! 📰`, 'assistant');
                        data.articles.slice(0, 5).forEach(article => {
                            addNewsArticleToChat(article);
                        });
                        addMessage(`තවත් පුවත් දැනගන්න අවශ්‍යද? ✨`, 'assistant');
                    } else {
                        addMessage(`අනේ! ${query} පිළිබඳ කිසිම පුවතක් Javisට හොයාගන්න බැරි වුණා. වෙන දෙයක් බලමුද? 🤔`, 'assistant');
                    }
                } catch (error) {
                    console.error('Error fetching news (catch block):', error);
                    throw error;
                }
            }

            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreviewImg.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.classList.add('hidden');
                    imagePreviewImg.src = '';
                }
            });

            sendButton.addEventListener('click', () => {
                const message = userInput.value.trim();
                const uploadedImageBase64 = imagePreviewImg.src.startsWith('data:image') ? imagePreviewImg.src : null;

                if (message && uploadedImageBase64) {
                    handleApiCall(() => editImage(uploadedImageBase64, message), 'image edit');
                } else if (message) {
                    handleApiCall(() => sendMessageToJavis(message), 'chat');
                } else if (uploadedImageBase64) {
                    addMessage(`ඔබ රූපයක් යැව්වා! රූපය edit කරන්න හෝ එයින් අලුත් රූපයක් හදන්න අවශ්‍ය විස්තරයක් දෙන්න! 📸`, 'user'); 
                    addImageToChat(uploadedImageBase64, 'user'); 
                } else {
                    addMessage("Javisට යවන්න දෙයක් ලියන්න, නැත්නම් රූපයක් තෝරන්න! 😅", 'assistant');
                }
                userInput.value = '';
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });

            makeFunnyButton.addEventListener('click', () => {
                const textToRephrase = userInput.value.trim();
                handleApiCall(() => rephraseTextFunnily(textToRephrase), 'rephrase');
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });

            generateImageButton.addEventListener('click', () => {
                const imagePrompt = userInput.value.trim();
                handleApiCall(() => generateImage(imagePrompt), 'image generation');
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });
            
            editImageButton.addEventListener('click', () => {
                const imagePrompt = userInput.value.trim();
                const uploadedImageBase64 = imagePreviewImg.src.startsWith('data:image') ? imagePreviewImg.src : null;

                if (uploadedImageBase64 && imagePrompt) {
                    handleApiCall(() => editImage(uploadedImageBase64, imagePrompt), 'image edit');
                } else if (!uploadedImageBase64) {
                    addMessage("රූපයක් edit කරන්න මුලින්ම රූපයක් upload කරන්න! 🖼️", 'assistant');
                } else {
                    addMessage("රූපය edit කරන්න ඕන විදිය ගැන විස්තරයක් (prompt එකක්) දෙන්න! ✏️", 'assistant');
                }
                userInput.value = '';
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });

            generateCodeButton.addEventListener('click', () => {
                const codePrompt = userInput.value.trim();
                handleApiCall(() => generateCode(codePrompt), 'code generation');
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });

            summarizeTextButton.addEventListener('click', () => {
                const textToSummarize = userInput.value.trim();
                handleApiCall(() => summarizeText(textToSummarize), 'summarize');
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });

            getWeatherButton.addEventListener('click', () => {
                const city = userInput.value.trim();
                if (city) {
                    handleApiCall(() => getWeather(city), 'weather');
                    userInput.value = '';
                } else {
                    addMessage("කාලගුණය දැනගැනීමට නගරයක් සඳහන් කරන්න. 🏙️", 'assistant');
                }
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });

            getNewsButton.addEventListener('click', () => {
                const query = userInput.value.trim() || 'latest news Sri Lanka'; 
                handleApiCall(() => getNews(query), 'news');
                imagePreview.classList.add('hidden');
                imagePreviewImg.src = '';
            });

            userInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    const message = userInput.value.trim();
                    const uploadedImageBase64 = imagePreviewImg.src.startsWith('data:image') ? imagePreviewImg.src : null;

                    if (message && uploadedImageBase64) {
                        handleApiCall(() => editImage(uploadedImageBase64, message), 'image edit');
                    } else {
                        sendButton.click(); 
                    }
                }
            });

            setTimeout(() => {
                welcomeOverlay.classList.add('fade-out');
            }, 3000); 
        });
    </script>
</body>
</html>
